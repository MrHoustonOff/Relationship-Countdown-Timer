// /mrhoustontimer/app/static/js/effects.js
/**
 * @fileoverview –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —á–∞—Å—Ç–∏—Ü.
 */

/**
 * –°–æ–∑–¥–∞–µ—Ç –∏ –∞–Ω–∏–º–∏—Ä—É–µ—Ç –Ω–∞–±–æ—Ä —á–∞—Å—Ç–∏—Ü (—Å–∏–º–≤–æ–ª–æ–≤), –≤—ã–ª–µ—Ç–∞—é—â–∏—Ö –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞.
 * –ß–∞—Å—Ç–∏—Ü—ã –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É—é—Ç—Å—è –∞–±—Å–æ–ª—é—Ç–Ω–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport –∏ —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏.
 * –ê–Ω–∏–º–∞—Ü–∏—è —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è CSS (`particle-fly-out` keyframes) —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
 * `--particle-x` –∏ `--particle-y` –¥–ª—è –∫–æ–Ω–µ—á–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏.
 *
 * @param {object} options - –û–±—ä–µ–∫—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —á–∞—Å—Ç–∏—Ü.
 * @param {HTMLElement | null} options.originElement - DOM-—ç–ª–µ–º–µ–Ω—Ç, –∏–∑ —Ü–µ–Ω—Ç—Ä–∞ –∫–æ—Ç–æ—Ä–æ–≥–æ –±—É–¥—É—Ç –≤—ã–ª–µ—Ç–∞—Ç—å —á–∞—Å—Ç–∏—Ü—ã. –ï—Å–ª–∏ null, —Ñ—É–Ω–∫—Ü–∏—è –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç.
 * @param {string} options.symbol - –°–∏–º–≤–æ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä, emoji 'üíñ' –∏–ª–∏ 'üéâ'), –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ —á–∞—Å—Ç–∏—Ü—ã.
 * @param {number} [options.count=10] - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö —á–∞—Å—Ç–∏—Ü. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 10.
 * @param {number} [options.spread=180] - –£–≥–æ–ª (–≤ –≥—Ä–∞–¥—É—Å–∞—Ö), –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –∫–æ—Ç–æ—Ä–æ–≥–æ —á–∞—Å—Ç–∏—Ü—ã –±—É–¥—É—Ç —Ä–∞–∑–ª–µ—Ç–∞—Ç—å—Å—è —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º. 180 –≥—Ä–∞–¥—É—Å–æ–≤ –æ–∑–Ω–∞—á–∞–µ—Ç –ø–æ–ª—É–∫—Ä—É–≥. 360 - –ø–æ–ª–Ω—ã–π –∫—Ä—É–≥. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 180 (–ø–æ–ª—É–∫—Ä—É–≥ –≤–≤–µ—Ä—Ö).
 * @param {number} [options.duration=1200] - –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏—Ü—ã –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö. –ß–∞—Å—Ç–∏—Ü–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞ –∏–∑ DOM –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —ç—Ç–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1200 –º—Å.
 * @param {number} [options.distance=300] - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ (–≤ –ø–∏–∫—Å–µ–ª—è—Ö), –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ —á–∞—Å—Ç–∏—Ü–∞ –º–æ–∂–µ—Ç —É–ª–µ—Ç–µ—Ç—å –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ `originElement`. –†–µ–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –±—É–¥–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º –æ—Ç 50% –¥–æ 100% —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 300px.
 * @param {string} [options.particleClass=''] - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π CSS-–∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –∫ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏—Ü–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'month-particle' –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Å—Ç–∏—Ü –º–µ—Å—è—Ü–∞). –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞.
 */
function spawnParticles({
    originElement,
    symbol,
    count = 10,
    spread = 180,
    duration = 1200,
    distance = 300,
    particleClass = ''
}) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
    if (!originElement || !(originElement instanceof Element)) {
        console.warn("[spawnParticles] –≠–ª–µ–º–µ–Ω—Ç-–∏—Å—Ç–æ—á–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.");
        return;
    }
    if (!symbol) {
        console.warn("[spawnParticles] –°–∏–º–≤–æ–ª —á–∞—Å—Ç–∏—Ü—ã –Ω–µ —É–∫–∞–∑–∞–Ω.");
        return; // –ù–µ —Å–ø–∞–≤–Ω–∏–º, –µ—Å–ª–∏ –Ω–µ—Ç —Å–∏–º–≤–æ–ª–∞
    }

    try {
        const originRect = originElement.getBoundingClientRect();
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
        const originX = originRect.left + originRect.width / 2;
        const originY = originRect.top + originRect.height / 2;

        console.debug(`[spawnParticles] –°–ø–∞–≤–Ω–∏–º ${count} —á–∞—Å—Ç–∏—Ü '${symbol}' –∏–∑ (${originX.toFixed(0)}px, ${originY.toFixed(0)}px)`);

        // –°–æ–∑–¥–∞–µ–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å—Ç–∏—Ü
        for (let i = 0; i < count; i++) {
            const particle = document.createElement('span');
            // –î–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –∫–ª–∞—Å—Å 'particle' –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å
            particle.className = `particle ${particleClass || ''}`.trim();
            particle.textContent = symbol; // –ò—Å–ø–æ–ª—å–∑—É–µ–º textContent –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –≤ —Ü–µ–Ω—Ç—Ä–µ —ç–ª–µ–º–µ–Ω—Ç–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
            particle.style.position = 'fixed'; // –ò—Å–ø–æ–ª—å–∑—É–µ–º fixed –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ viewport
            particle.style.left = `${originX}px`;
            particle.style.top = `${originY}px`;
            // –ù–∞—á–∞–ª—å–Ω—ã–π transform –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∞–º–æ–π —á–∞—Å—Ç–∏—Ü—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–æ—á–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)
            // particle.style.transform = 'translate(-50%, -50%)'; // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –µ—Å–ª–∏ —Ü–µ–Ω—Ç—Ä —Å–∏–º–≤–æ–ª–∞ –≤–∞–∂–µ–Ω

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —É–≥–æ–ª —Ä–∞–∑–ª–µ—Ç–∞
            // –°–º–µ—â–µ–Ω–∏–µ -90 –≥—Ä–∞–¥—É—Å–æ–≤ –¥–ª—è –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è "–≤–≤–µ—Ä—Ö" –ø—Ä–∏ spread=180 –Ω–æ —è –µ–≥–æ –ø–æ–º–µ–Ω—è–ª
            const angleOffset = 90;
            const randomAngleDeg = (Math.random() * spread - (spread / 2)) + angleOffset;
            const angleRad = randomAngleDeg * (Math.PI / 180);

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
            // –ß–∞—Å—Ç–∏—Ü—ã –ª–µ—Ç—è—Ç –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç 50% –¥–æ 100% –æ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ `distance`
            const currentDistance = (Math.random() * 0.5 + 0.5) * distance;

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–Ω–µ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Å–º–µ—â–µ–Ω–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            const endX = Math.cos(angleRad) * currentDistance;
            const endY = Math.sin(angleRad) * currentDistance;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ @keyframes particle-fly-out
            particle.style.setProperty('--particle-x', `${endX.toFixed(2)}px`);
            particle.style.setProperty('--particle-y', `${endY.toFixed(2)}px`);
            // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∑–∞–¥–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –µ—Å–ª–∏ CSS –Ω–∞—Å—Ç—Ä–æ–µ–Ω
            // particle.style.animationDuration = `${duration}ms`;

            // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Å—Ç–∏—Ü—É –≤ DOM (–≤ –∫–æ–Ω–µ—Ü body, —á—Ç–æ–±—ã –±—ã–ª–∞ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ)
            document.body.appendChild(particle);

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —á–∞—Å—Ç–∏—Ü—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏
            setTimeout(() => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –µ—â–µ —á–∞—Å—Ç–∏—Ü–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                if (particle.parentNode) {
                    particle.remove();
                }
            }, duration);
        }
    } catch (error) {
        console.error("[spawnParticles] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞—Å—Ç–∏—Ü:", error);
    }
}